* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v2.0 on Jun, 14. 2018. JOBID=1528989820
* read crd files and generate Drude PSF
* NB: Water must be last segment generated do to noangle nodihedral
*

DIMENS CHSIZE 3000000 MAXRES 3000000

! Read topology and parameter files
stream toppar_drude.str

!obtain number of segments and segment names
stream step1_reader_nseg.str

set count 1

label loop_segid

   stream step1_reader_seg@count.str

   open read unit 10 card name step1_reader_seg@count.crd
   read sequence coor unit 10 RESI  !!!SEGI @segname

   set nterpatch @nter
   if @nterpatch .eq. NTER if @rname .eq. GLY set nterpatch GNTE
   if @nterpatch .eq. NTER if @rname .eq. PRO set nterpatch PROP
   if @nterpatch .eq. ACE  if @rname .eq. PRO set nterpatch ACP

   set cterpatch @cter
   if @cterpatch .eq. CTER if @cname .eq. GLY set cterpatch CTEG
   if @cterpatch .eq. CTER if @cname .eq. PRO set cterpatch CTEP
   if @cterpatch .eq. CNEU if @cname .eq. GLY set cterpatch CNEG
   if @cterpatch .eq. CT1  if @cname .eq. GLY set cterpatch CT1G
   if @cterpatch .eq. CT2  if @cname .eq. GLY set cterpatch CT2G

   set gene = 0
   if @type eq protein then
      !standard protein
      generate @segname first @nterpatch last @cterpatch setup warn drude dmass 0.4 ! show
      set gene = 1
   endif

   if @type eq rna then  !UMB: explicitly for rna
      !
      !STANDARD RNA NOT SUPPORTED BY TOPPAR_DRUDE_NA_2017B.STR 
      !
      stop
      !generate @segname first @nterpatch last @cterpatch setup warn drude dmass 0.4 ! show
   endif

   if @type eq dna then     !UMB: explicitly for dna
      bomlev -2  !UMB
      !standard dna
      generate @segname first @nterpatch last @cterpatch setup warn drude dmass 0.4 ! show

      define dnaseg sele type C3' .and. segid @segname end
      set totres ?nsel

      set gene = 1
      set cntdna = 1
      label loop_patch_dna
         define cntdna sele ( type C3' .and. segid @segname ) .subset. @cntdna end
         set cntres = ?selresi
         patch deox @segname @cntres setup warn

      incr cntdna by 1
      if cntdna .lt. @totres  goto loop_patch_dna !UMB for last nucleotide it should be different patch

      define cntdna sele ( type C3' .and. segid @segname ) .subset. @cntdna end
      set cntres = ?selresi
      patch deo3 @segname @cntres setup warn      !UMB: deo3 path for terminal nucleotide
      autogenerate angle dihe
      bomlev 0 !UMB
   endif

   if @type eq water then
      ! water
      generate @segname first none last none setup warn noangle nodihedral drude dmass 0.4 ! show
      set gene = 1
   endif

   if gene .eq. 0 then
      ! default generate if not protein or water
      generate @segname first none last none setup warn drude dmass 0.4 ! show
   endif

   !read coordinates
   rewind unit 10
   read coor card unit 10 append

   ! patch
   if qpatch .eq. yes then
      stream step1_reader_patch@count.str
   endif
   
label continue_segid
incr count by 1
if count le @nsegid goto loop_segid

coor sdrude
define ninit sele .not. init .and. hydr end
if ?nsel .gt. 0 then
   ic para
   ic build
   coor sdrude
endif
coor shake
!coor print

nbonds atom vatom switch vswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0
energy

!write full coordinate set
open write unit 10 card name step2_drude.psf
write psf card unit 10

open write unit 10 card name step2_drude.xplor.psf
write psf card unit 10 xplor

open write unit 10 card name step2_drude.pdb
write coor pdb unit 10

open write unit 10 card name step2_drude.crd
write coor card unit 10

! namd restraints
scalar wmain set 0
scalar wmain set 1 sele .not. resn swm4 .and. .not. type D* end
system "mkdir -p namd/restraints"
write coor pdb name namd/restraints/bb_rmsd.ref

stop